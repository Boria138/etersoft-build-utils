#!/bin/sh

# load common functions, compatible with local and installed script
. `dirname $0`/../share/eterbuild/functions/common
load_mod git

test -r "$1" && fatal "Do not need any files in params"

if is_girar_name $1 ; then
	GIRARHOST=$1
	shift
fi

mygetopts()
{

	if [ "$1" = "-h" ] ; then
		echog "gacl - acl control for gear repo in $GIRARHOST"
		echog "Use: gacl [GIRAR] [-$CURRENTBRANCHNAME] | [-b REPONAME]  [package] command [params]"
		echog "Options:"
		echog " -b REPONAME - binary repository name (4.1, 5.0, 5.1 and so on)"
		echog "Examples:"
		echog "    gacl [-$CURRENTBRANCHNAME] package add newuser"
		echog "    gacl [-$CURRENTBRANCHNAME] package del newuser"
		echog "    gacl [-$CURRENTBRANCHNAME] package show"
		exit 0
	fi

	if [ "$1" = "-b" ] ; then
		BINARYREPONAME="$2"
		shift 2
	fi

	# FIXME
	# if two or one param only, try detect
	if [ -z "$3" ] || [ -z "$2" ] ; then
		# TODO
		PROJECTNAME=$(get_gear_name)
	else
		PROJECTNAME=$1
		shift
	fi
	#echo PROJNAME: $PROJECTNAME

	COMMAND=$1
	shift
	#echo COMMAND: $COMMAND

	PARAM=$1
	shift

}

#parse_cmd_pre_spec "$@"
parse_cmd_pre "$@"
mygetopts $LISTARGS
# see functions/alt:set_binaryrepo() for BINARYREPONAME
set_binaryrepo $MENV

[ -n "$PROJECTNAME" ] || fatal "Project name is missed"
[ -n "$COMMAND" ] || fatal "Command is missed"

case "$COMMAND" in
	"add"|"del")
		[ -n "$PARAM" ] || fatal "Param for command is missed"
		echo "$GIRARHOST:$BINARYREPO ACL for $PROJECTNAME: $COMMAND $PARAM..."
		ssh $GIRARHOST acl $BINARYREPO $PROJECTNAME $COMMAND $PARAM
		;;
	"show")
		echo -n "$GIRARHOST:$BINARYREPO ACL for "
		ssh $GIRARHOST acl $BINARYREPO $PROJECTNAME $COMMAND
		;;
	*)
		fatal "Unknown command $COMMAND"
		;;
esac

