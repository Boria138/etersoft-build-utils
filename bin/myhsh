#!/bin/bash
# 2003-2006, 2008-2010, 2013 (c) Etersoft www.etersoft.ru
# Author: Vitaly Lipatov <lav@etersoft.ru>
# Public domain
#
# Пересборка указанных SRPM-пакетов в hasher
# -i устанавливает в тестовый hasher после пересборки

# load common functions, compatible with local and installed script
. `dirname $0`/../share/eterbuild/functions/common
load_mod hasher check

TESTINSTALL=
WITHSTUFF="--with-stuff"

#############################
Usage="Usage: $name [-i -c -l] src.rpm..."
function mygetopts()
{
name=${0##*/}
Descr="$name - build package via hasher"

phelp()
{
	echog "$Descr"
	echog "$Usage"
	echo
	echog "Options:"
	echog "   -i  install built packages in test hasher"
	echog "   -c  build without stuff (without previous built packages)"
	echog "   -l  lazy cleanup (before build, not after)"

}

while getopts :hicl opt; do
    case $opt in
    h) phelp; exit 0;;
    i) TESTINSTALL=1;;
    l) HASHERARG="$HASHERARG --lazy-cleanup";;
    c) WITHSTUFF="--without-stuff";;
    +?) echog "$name: options should not be preceded by a '+'." 1>&2; exit 2;;
    ?) OPTIND=$((OPTIND-1)); break;
    esac
done

# remove args that were options
if [ $# -gt 0 ]; then 
	shift $((OPTIND - 1))
fi

LISTRPMARGS=$@
}


parse_cmd_pre "$@"
mygetopts $LISTARGS

RESULT=0

HASHERARG="$HASHERARG $WITHSTUFF"
set_hasherdir

mkdir -p $LOGDIR $HASHERDIR || fatal "cannot mkdir"
check_locking

echog "List of packages for build: \$LISTNAMES"

if [ -z "${LISTNAMES/*spec/}"  ] ; then
	echo "!!!!!!!!"
	fatal "Please use src.rpm as argument, not spec"
fi

# Skip checking for tar arg
if [ -n "${LISTNAMES/*tar/}" ] ; then
	echog -n "Checking with sisyphus_check... with $HASHER_NOCHECK skipping"
	sisyphus_check --no-check=$HASHER_NOCHECK --files $LISTNAMES || fatal "check for sisyphus failed"
	echog "OK"
fi

# export OURAPTCONF with temp. file contains correct path to sources.list
# use MENV
prepare_aptconfig

# FIXME: we override config value here?
# TODO: for add $LISTRPMARGS we need skip function for delete "our" params
# we do not need check cases for mount points, thanks ldv@ 
HASHERARG="--no-sisyphus-check=$HASHER_NOCHECK --apt-config=$OURAPTCONF --target $BUILDARCH $HASHERARG"
HASHERARG="--mountpoints=/proc,/dev/pts $HASHERARG"

BUILDARGS=""

if [ -z "$NOSTRICT_UNPACKAGED" ] ; then
	BUILDARGS="$BUILDARGS --define '_unpackaged_files_terminate_build 1'"
fi

LISTBUILTSH=""
for i in $LISTNAMES
do
	LOGFILE="$LOGDIR/`basename $i .src.rpm`$MENVARG.log"
	echo "Build in hasher ($MENV) in $HASHERDIR dir" >$LOGFILE
	rm -f $LOGFILE.failed
	echog "Build in hasher: $i (arg: $HASHERARG --build-args \"$BUILDARGS\", distro: $MENV, hasherdir: $HASHERDIR)"

	# Note: hasher is already use renice for low priority
	showcmd $HSH $HASHERARG --build-args "$BUILDARGS" -- $HASHERDIR $i
	($HSH $HASHERARG --build-args "$BUILDARGS" -- $HASHERDIR $i 2>&1 || touch $LOGFILE.failed) | tee -a $LOGFILE
	test -L $HASHERDIR/BUILD || ln -s chroot/usr/src/RPM/BUILD $HASHERDIR/
	if [ -f $LOGFILE.failed ] ; then
		RESULT=1
		break
	fi
	check_log $LOGFILE ; RESULT=$?
	test $RESULT = 1 && break
	echog "########## Build of `basename $i` is done in hasher $MENV  #############"
	echo
	LISTBUILTSH="$LISTBUILTSH$i "
	LASTPACKAGE=$i
done

echo
if [ "$RESULT" = "1" ] ; then
	echo
	echog "!!!!!!! Hasher: FAILED FAILED FAILED !!!!!!!!!"
	echog "Build failed with $i, built only"
else
	echog "Full list of the hashered packages:"
fi
print_list $LISTBUILTSH

echo
if [ "$RESULT" = "0" ] && [ -n "$TESTINSTALL" ] ; then
	# test install (only for last package in list)
	# some key for build hasher from scratch
	echog "Find binary packages for '$(basename $LASTPACKAGE)' in $HASHERDIR/repo/$BUILDARCH/RPMS.hasher..."
	BINPACKAGES=`get_binpkg_list $HASHERDIR/repo/$BUILDARCH/RPMS.hasher $LASTPACKAGE | estrlist reg_exclude debuginfo -`
	test -n "$BINPACKAGES" || fatal "Can't find binary packages for $LASTPACKAGE in `ls -l $HASHERDIR/repo/$BUILDARCH/RPMS.hasher`"
	echo "List: $BINPACKAGES"
	echo
	docmd $ETERBUILDBIN/loginhsh -a $MENVARG $BINPACKAGES
	exit
fi

exit $RESULT
