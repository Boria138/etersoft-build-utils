#!/bin/sh
# 2017, 2018, 2019 (c) Etersoft https://etersoft.ru
# Author: Vitaly Lipatov <lav@etersoft.ru>
# Public domain

# load common functions, compatible with local and installed script
. `dirname $0`/../share/eterbuild/functions/common
load_mod git

set_girar_host $1 && shift

if [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
	echo "gitask — ssh gear.alt task wrapper"
	echo "Use: gitask [GIRAR] [task|add|log|show|ls|quota]"
	echo "$HELP_GIRAR"
	echo "     --help - help"
	docmd ssh $GEARHOST task help | sed -e "s|abort|cancel|g"
	echo
	echo "Examples:"
	echo "     new    [p8]                 - create new task [on p8 branch, Sisyphus by default]"
	echo "     run    [NNNN]               - run task NNNN"
	echo "     commit [NNNN] [NNNN2]       - commit task(s) NNNN, [NNNN2]"
	echo "     add del package [package2]  - add package remove command"
	echo "     add --help                  - show task add help"
	echo "     task --help                 - show task help"
	echo "     share  NNNN [enable]        - share task NNNN"
	echo "     deps   NNNN add XXXX        - add deps from XXXX to task NNNN"
	echo "     copy   NNNN to (p8|p9) [from XX]  - copy package from Sisyphus to (p8|p9) [from XX]"
	echo "     find   PACKAGE              - do find-package of PACKAGE"
	echo "     log    NNNN                 - show build log for task NNNN"
	echo "     show   NNNN                 - show subtask list for task NNNN"
	echo "     quota                       - show quota on the build server"
	echo "     cancel NNNN                 - cancel task NNNN"
	echo "     rebuild --help              - rebuild package"
	exit 0
fi

get_last()
{
	ssh $GEARHOST task ls | head -n1 | sed -e "s|^#\([0-9]*\) .*|\1|g"
}

get_test_status()
{
	ssh $GEARHOST task ls | grep "^#$1 " | grep "\[test-only\]"
}

# TODO: acl

epm assure girar-show girar-utils

if [ "$1" = "get" ] ; then
	if [ "$1 $2" = "get subtask" ] ; then
		[ -n "$3" ] || fatal "get subtask TASK PROJECTNMAE"
		# get subtask number from TASKNUMBER for PROJECTNAME
		SUBTASK="$(ssh $GEARHOST task show $3 | grep "/$4.git" | sed -e "s|^ \([0-9]*\):.*|\1|g")" || fatal
		#"
		echo "$SUBTASK"
		exit
	elif [ "$1 $2 $3" = "get last " ] || [ "$1 $2 $3" = "get last task" ] ; then
		TASK="$(get_last)" || fatal
		echo "$TASK"
		exit
	else
		fatal "Unknown command $1 $2"
	fi
fi

if [ "$1" = "find" ] ; then
	shift
	#showcmd "$GEARHOST>" find-packages "$@"
	docmd ssh $GITHOST find-package "$@"
	exit
fi

if [ "$1" = "rebuild" ] ; then
	shift
	showcmd "$GEARHOST>" build rebuild "$@"
	docmd ssh $GEARHOST build rebuild "$@"
	exit
fi

if [ "$1" = "log" ] ; then
	shift
	TASK="$1"
	[ -n "$TASK" ] || TASK="$(get_last)" || fatal
	showcmd "$GEARHOST>" girar-show "$TASK"
	GIT_ALT=$GEARHOST girar-show "$TASK"
	exit
fi

if [ "$1" = "ls" ] ; then
	shift
	if [ "$1" = "--all" ] ; then
		ssh $GEARHOST task ls "$@"
		exit
	fi
	# TODO: with arg(s) — subtask
	# TODO: add support ls -a (with subtasks)
	showcmd "$GEARHOST>" girar-show "$@"
	GIT_ALT=$GEARHOST girar-show "$@"
	exit
fi

if [ "$1" = "quota" ] ; then
	docmd ssh $GEARHOST quota
	exit
fi

if [ "$1" = "copy" ] ; then
	shift
	PACKAGELIST=''
	while [ -n "$1" ] ; do
		[ "$1" = "to" ] && break
		PACKAGELIST="$PACKAGELIST $1"
		shift
	done

	[ "$1" = "to" ] || fatal "missed 'to' in your command"
	shift # to
	TARGET="$1"
	shift

	FROMSTR=''
	[ "$1" = "from" ] && FROMSTR="$1 $2"

	[ -n "$PACKAGELIST" ] || fatal "no packages"
	docmd ssh $GEARHOST task new $TARGET
	TASK="$(get_last)"
	for PACKAGE in $PACKAGELIST ; do
		docmd ssh $GEARHOST task add $TASK copy $PACKAGE $FROMSTR
	done
	docmd ssh $GEARHOST task run $TASK
	exit
fi

if [ "$1" = "add" ] ; then
	if [ "$2" = "del" ] || [ "$3" = "del" ] ; then
		shift
		if [ "$1" = "del" ] ; then
			shift
			TASK="$(get_last)"
		else
			TASK="$1"
			shift 2
		fi

		PACKAGELIST=''
		while [ -n "$1" ] ; do
			PACKAGELIST="$PACKAGELIST $1"
			shift
		done

		[ -n "$PACKAGELIST" ] || fatal "no packages"
		for PACKAGE in $PACKAGELIST ; do
			docmd ssh $GEARHOST task add $TASK copy $PACKAGE $FROMSTR
		done
		exit
	fi
fi



if [ "$1" = "commit" ] ; then
	shift
	COMMIT=''
	TASKLIST="$*"
	if [ -z "$TASKLIST" ] ; then
		TASKLIST="$(get_last)" || fatal "Can't get last task"
	fi
	for TASK in $TASKLIST ; do
		docmd ssh $GEARHOST task run --commit "$TASK"
	done
	exit
fi

if [ "$1" = "run" ] ; then
	shift

	COMMIT=''
	PARAMTEST=''
	TASK=''

	while [ -n "$1" ] ; do
		if echo "$1" | grep -qv "^--" ; then
			TASK="$1"
		elif [ "$1" = "--commit" ] ; then
			COMMIT=1
		elif [ "$1" = "--force" ] ; then
			COMMIT=1
		elif [ "$1" = "--test" ] || [ "$1" = "--test-only" ] ; then
			PARAMTEST='--test-only'
		else
			info "Unknown param $1"
		fi
		shift
	done

	[ -n "$TASK" ] || TASK="$(get_last)" || fatal "Can't get last task"

	# keep test status
	get_test_status "$TASK" && PARAMTEST='--test-only'
	# force reset test status
	[ -n "$COMMIT" ] && PARAMTEST='--commit'

	docmd ssh $GEARHOST task run $PARAMTEST "$TASK"
	exit
fi

if [ "$1" = "cancel" ] ; then
	shift
	#TASK="$(get_last)" || fatal
	if [ "$GEARHOST" = "git.eter" ]  || [ "$GEARHOST" = "git.office" ] ; then
		docmd ssh $GEARHOST task cancel "$@"
	else
		docmd ssh $GEARHOST task abort "$@"
	fi
	exit
fi

if [ "$1" = "share" ] && [ -n "$2" ] ; then
	#shift
	docmd ssh $GEARHOST task share "$2" enable
	exit
fi


if [ "$1" = "task" ] ; then
	# by default
	shift
fi

docmd ssh $GEARHOST task "$@"

